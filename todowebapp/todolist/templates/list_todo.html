{% extends "master.html" %}
{% block content %}
    <table class="table table-sm my-table my-4">
      <thead>
        <tr>
          <th scope="col"></th>
          <th scope="col"><i class="bi bi-arrow-repeat" style="font-size:1.1rem"></i></th>
          <th scope="col" class="text-secondary"><i class="bi bi-type" style="font-size:1rem"></i> Task name</th>
          <th scope="col" class="text-secondary"><i class="bi bi-caret-down-square" style="font-size:1rem"></i> Priority</th>
          <th scope="col" class="text-secondary"><i class="bi bi-calendar" style="font-size:1rem"></i> Due to</th>
          <th scope="col" class="text-secondary"><i class="bi bi-type" style="font-size:1rem"></i> Comment</th>
          <th scope="col" class="text-secondary"><i class="bi bi-people-fill" style="font-size:1rem"></i> Deliver to</th>
          <th scope="col" class="text-secondary"><i class="bi bi-clock-fill" style="font-size:1rem"></i> Created</th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
        <tr>
          <td>
            <button type="button" class="btn btn-link p-0 border-0 text-decoration-none"
                    title="Edit" data-bs-toggle="modal" data-bs-target="#editTaskModal"
                    data-action="{% url 'task_update' task.id %}"
                    data-id="{{ task.id }}"
                    data-title="{{ task.title|escape }}"
                    data-status="{{ task.status }}"
                    data-due="{{ task.due_date|date:'Y-m-d'|default_if_none:'' }}"
                    data-priority="{{ task.priority }}"
                    data-comment="{{ task.comment|default_if_none:''|escape }}"
                    data-delivered_to="{{ task.delivered_to|default_if_none:''|escape }}">
              <i class="bi bi-pencil" style="font-size:1rem; color:dodgerblue;"></i>
            </button>
          </td>

          <td class="text-center" style="color: dodgerblue">
            {% if task.status == 0 %}
            <i class="bi bi-square"></i>
            {% elif task.status == 1 %}
            <i class="bi bi-square-half"></i>
            {% elif task.status == 2 %}
            <i class="bi bi-square-fill"></i>
            {% endif %}
          </td>
          
          <td class="compress-cell">{{ task.title }}</td>
          
          <td class="text-center">
            {% if task.priority == 0 %}
              <span class="priority-badge low">{{ task.get_priority_display }}</span>
            {% elif task.priority == 1 %}
              <span class="priority-badge med">{{ task.get_priority_display }}</span>
            {% elif task.priority == 2 %}
              <span class="priority-badge high">{{ task.get_priority_display }}</span>
            {% elif task.priority == 3 %}
              <span class="priority-badge urgent">{{ task.get_priority_display }}</span>
            {% else %}
              {{ task.get_priority_display }}
            {% endif %}
          </td>


          <td
            {% if task.due_date %}
              {% if task.due_date < today %}style="color:red"
              {% elif task.due_date == today %}style="color:orange"
              {% endif %}
            {% endif %}
          >
            {{ task.due_date|default:"—" }}
          </td>
          <td class="compress-cell">{{ task.comment|default:"—" }}</td>
          <td>{{ task.delivered_to|default:"—" }}</td>
          <td>{{ task.created_at }}</td>
        </tr>
        {% endfor %}
        
        <tr class="table">
          <td colspan="9" class="text-center">
            <button type="button" class="btn text-secondary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
              <i class="bi bi-plus-circle text-secondary"></i> Add new task
            </button>
          </td>
        </tr>
        
      </tbody>
    </table>

    <!-- New Task Modal -->
    <div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border rounded p-2 bg-light" style="font-size: 0.9rem;">
          
          <div class="modal-header">
            <h5 class="modal-title" id="newTaskModalLabel">New Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <form method="post" action="{% url 'task_create' %}" autocomplete="off">
            <div class="modal-body">
              {% csrf_token %}
              {{ form.as_p }}
            </div>

            <div class="modal-footer d-flex justify-content-center">
              <button type="submit" class="btn btn-success btn-sm">
                <i class="bi bi-check-circle"></i> Save
              </button>
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border rounded p-2 bg-light" style="font-size: 0.9rem;">

          <div class="modal-header">
            <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <form id="editTaskForm" method="post" action="" autocomplete="off"> <!-- the action is defined in JS below -->
            <div class="modal-body">
              {% csrf_token %}
              {{ form.as_p }}
            </div>
            <div class="modal-footer d-flex justify-content-center">
              <button type="submit" class="btn btn-success btn-sm">
                <i class="bi bi-check-circle"></i> Save
              </button>
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

{% endblock %}
{% block css %}
    {{ block.super}} {# richiama il blocco del padre #}
    <style>
      td.compress-cell {
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      td.compress-cell:hover {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        z-index: 1;
        position: relative;
      }

      .my-table thead th {
        color: grey;
        font-weight: normal;
        font-size: 0.95rem;
      }
      .my-table thead th i {
        color: inherit;
      }
      .my-table {
        font-size: 0.95rem;
        font-weight: normal;
      }
      .my-table {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Helvetica, "Apple Color Emoji", Arial, sans-serif,
                    "Segoe UI Emoji", "Segoe UI Symbol";
        font-weight: 400;
        color: #2f3437;
      }

      .priority-badge {
        display: inline-block;
        padding: 2px 10px;
        border: none;
        border-radius: 5px;
        font-size: 0.8rem;
        font-weight: 600;
        line-height: 1.3;
        text-transform: capitalize;
      }

      .priority-badge.low {
        background-color: #dff3e3;
        color: #2e604a;
        border-color: #c3e7cd;
      }

      .priority-badge.med {
        background-color: #fef4d8;
        color: #8a6d1f;
        border-color: #f8e7b3;
      }

      .priority-badge.high {
        background-color: #fce5e5;
        color: #a13232;
        border-color: #f5c2c2;
      }

      .priority-badge.urgent {
        background-color: #f1e6ff;
        color: #6b3bb0;
        border-color: #e2d3ff;
      }
    </style>
{% endblock %}
{% block javascript %}
    {{ block.super}}
    <script>
    document.getElementById('editTaskModal').addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const id = button.getAttribute('data-id');

      const form = document.getElementById('editTaskForm');
      form.action = button.getAttribute('data-action');

      const get = (attr) => (button.getAttribute(attr) || '').trim();

      form.elements['title'].value = get('data-title');
      form.elements['priority'].value = get('data-priority');
      form.elements['status'].value = get('data-status');

      const dueVal = get('data-due'); // must be 'YYYY-MM-DD' or ''
      const dueInput = form.elements['due_date'];
      if (dueInput) {
        if (dueVal) {
          dueInput.value = dueVal;

          if (!dueInput.value) {
            const [y,m,d] = dueVal.split('-').map(Number);
            // valueAsDate wants 0-based months
            const local = new Date(y, m - 1, d);
            if (!isNaN(local)) dueInput.valueAsDate = local;
          }
        } else {
          dueInput.value = '';
        }
      }

      form.elements['comment'].value      = get('data-comment');
      form.elements['delivered_to'].value = get('data-delivered_to');
    });
    </script>
{% endblock %}