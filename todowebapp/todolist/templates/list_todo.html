{% extends "master.html" %}
{% load static %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center my-2">
    <h6 class="text-secondary mb-0" style="font-weight: 300; font-size: 1.7rem;">Tasks</h6>

    <form method="get" class="form-check m-0" action="{% url 'task_list' %}">
      <input
        class="form-check-input"
        type="checkbox"
        id="switchCheckDefault"
        name="show_completed"
        value="1"
        {% if view == 'all' %}checked{% endif %}
        onchange="this.form.submit()"
      >
      <label class="form-check-label" for="switchCheckDefault">
        Show completed tasks
      </label>
    </form>
  </div>

  <table class="table table-sm my-table my-3">
    <thead>
      <tr>
        <th scope="col"></th>
        <th scope="col"></th>
        <th scope="col"><i class="bi bi-arrow-repeat" style="font-size:1.1rem"></i></th>
        <th scope="col" class="text-secondary"><i class="bi bi-type" style="font-size:1rem"></i> Task name</th>
        <th scope="col" class="text-secondary"><i class="bi bi-caret-down-square" style="font-size:1rem"></i> Priority</th>
        <th scope="col" class="text-secondary"><i class="bi bi-calendar" style="font-size:1rem"></i> Due to</th>
        <th scope="col" class="text-secondary"><i class="bi bi-type" style="font-size:1rem"></i> Comment</th>
        <th scope="col" class="text-secondary"><i class="bi bi-people-fill" style="font-size:1rem"></i> Deliver to</th>
        <th scope="col" class="text-secondary"><i class="bi bi-clock-fill" style="font-size:1rem"></i> Created</th>
      </tr>
    </thead>
    <tbody>
      {% for task in tasks %}
      <tr>
        <td>
          <form method="post" action="{% url 'task_delete' %}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="pk" value="{{ task.id }}">
            <button type="submit" class="btn btn-link btn-sm p-0 border-0"
              onclick="return confirm('⚠️ This action is irreversible. Do you really want to delete this task?')">
              <i class="bi bi-trash fs-7" style="font-size:1rem; color:red;"></i>
            </button>
          </form>
        </td>
        <td>
          <button type="button" class="btn btn-link p-0 border-0 text-decoration-none"
                  title="Edit" data-bs-toggle="modal" data-bs-target="#editTaskModal"
                  data-action="{% url 'task_update' task.id %}"
                  data-id="{{ task.id }}"
                  data-title="{{ task.title|escape }}"
                  data-status="{{ task.status }}"
                  data-due="{{ task.due_date|date:'Y-m-d'|default_if_none:'' }}"
                  data-priority="{{ task.priority }}"
                  data-comment="{{ task.comment|default_if_none:''|escape }}"
                  data-delivered_to="{{ task.delivered_to|default_if_none:''|escape }}">
            <i class="bi bi-pencil" style="font-size:1rem; color:dodgerblue;"></i>
          </button>
        </td>

        <td class="text-center" style="color: grey">
          {% if task.status == 0 %}
          <i class="bi bi-circle"></i>
          {% elif task.status == 1 %}
          <i class="bi bi-circle-half"></i>
          {% elif task.status == 2 %}
          <i class="bi bi-check-circle-fill"></i>
          {% endif %}
        </td>
        
        <td class="compress-cell">{{ task.title }}</td>
        
        <td class="text-center">
          {% if task.priority == 0 %}
            <span class="priority-badge low">{{ task.get_priority_display }}</span>
          {% elif task.priority == 1 %}
            <span class="priority-badge med">{{ task.get_priority_display }}</span>
          {% elif task.priority == 2 %}
            <span class="priority-badge high">{{ task.get_priority_display }}</span>
          {% elif task.priority == 3 %}
            <span class="priority-badge urgent">{{ task.get_priority_display }}</span>
          {% else %}
            {{ task.get_priority_display }}
          {% endif %}
        </td>


        <td
          {% if task.due_date %}
            {% if task.due_date < today %}style="color:red"
            {% elif task.due_date == today %}style="color:orange"
            {% endif %}
          {% endif %}
        >
          {{ task.due_date|default:"—" }}
        </td>
        <td class="compress-cell">{{ task.comment|default:"—" }}</td>
        <td>{{ task.delivered_to|default:"—" }}</td>
        <td>{{ task.created_at }}</td>
      </tr>
      {% endfor %}
      
      <tr class="table">
        <td colspan="9" class="text-center">
          <button type="button" class="btn text-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
            <i class="bi bi-plus-circle text-primary"></i> Add new task
          </button>
        </td>
      </tr>
      
    </tbody>
  </table>

  <!-- New Task Modal -->
  <div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border rounded p-2 bg-light" style="font-size: 0.9rem;">
        
        <div class="modal-header">
          <h5 class="modal-title" id="newTaskModalLabel">New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form method="post" action="{% url 'task_create' %}" autocomplete="off">
          <div class="modal-body">
            {% csrf_token %}
            {{ form.as_p }}
          </div>

          <div class="modal-footer d-flex justify-content-center">
            <button type="submit" class="btn btn-success btn-sm">
              <i class="bi bi-check-circle"></i> Save
            </button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border rounded p-2 bg-light" style="font-size: 0.9rem;">

        <div class="modal-header">
          <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form id="editTaskForm" method="post" action="" autocomplete="off"> <!-- the action is defined in JS below -->
          <div class="modal-body">
            {% csrf_token %}
            {{ form.as_p }}
          </div>

          <div class="modal-footer d-flex justify-content-center">
            <button type="submit" class="btn btn-success btn-sm">
              <i class="bi bi-check-circle"></i> Save
            </button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>

{% endblock %}
{% block css %}
  {{ block.super}} {# richiama il blocco del padre #}
{% endblock %}
{% block javascript %}
  {{ block.super}}
  <script src="{% static 'todolist/js/edit-modal-fill.js' %}"></script>
{% endblock %}